<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, minimum-scale=1, user-scalable=yes" />
<title>â˜… æ”¶è—</title>
<link rel="stylesheet" href="styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#F3FCFD">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-startup-image" href="splash.png" />
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js");
    });
  }
</script>

</head>
<body>

<header>
  <div class="wrap">
    <h1>â˜… æ”¶è—</h1>
    <div class="nav">
      <a href="index.html">ç™¼éŸ³ç·´ç¿’</a>
      <a href="travel.html">æ—…éŠæœƒè©±</a>
      <a href="translate.html">AI ç¿»è­¯</a>
      <a class="active" href="favorites.html">â˜… æ”¶è—</a>
    </div>
    <div class="controls">
      <label>æ’­æ”¾é€Ÿåº¦
        <select id="rate" class="select">
          <option value="0.5">Ã—0.5</option>
          <option value="0.75" selected>Ã—0.75</option>
          <option value="1.0">Ã—1.0</option>
        </select>
      </label>
      <label class="control"><input type="checkbox" id="cartoonEn" />è‹±æ–‡å¡é€šæ¨¡å¼</label>
      <label>è‹±æ–‡è²éŸ³
        <select id="voiceEn" class="select"><option>è¼‰å…¥ä¸­â€¦</option></select>
      </label>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="legend">å·²æ”¶è—å¥å­</div>
  <div id="list" class="list"></div>
</main>

<footer>è³‡æ–™ä¿å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</footer>

<script>
const EN_WHITELIST = [
  {name:"Daniel",   lang:"en-GB"},
  {name:"Moira",    lang:"en-IE"},
  {name:"Samantha", lang:"en-AU"},
  {name:"Tessa",    lang:"en-ZA"}
];
function pickWhitelistedEnglishVoices(){
  const all = speechSynthesis.getVoices();
  const ok = [];
  EN_WHITELIST.forEach(w=>{
    const v = all.find(x => x.name===w.name && (x.lang||"").toLowerCase().startsWith(w.lang.toLowerCase()));
    if(v) ok.push(v);
  });
  return ok;
}
function populateEnglishVoices(){
  const sel = document.getElementById('voiceEn');
  sel.innerHTML = "";
  const list = pickWhitelistedEnglishVoices();
  if(!list.length){ sel.innerHTML = "<option>æœªæ‰¾åˆ°ï¼šDaniel / Moira / Samantha / Tessa</option>"; return; }
  list.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = v.name + " ("+v.lang+")";
    sel.appendChild(opt);
    if(i===0) sel.value = v.name;
  });
  const stored = localStorage.getItem('voiceEnName');
  if(stored && list.some(v=>v.name===stored)) sel.value = stored;
  sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value));
}
function rate(){ return parseFloat(document.getElementById('rate').value||'0.75'); }
function speakKO(t){
  const u = new SpeechSynthesisUtterance(t);
  const ko = speechSynthesis.getVoices().find(v => /ko/i.test(v.lang||""));
  if(ko) u.voice = ko;
  u.lang='ko-KR'; u.rate = rate();
  if(document.getElementById('cartoonEn').checked) u.pitch=1.6;
  speechSynthesis.speak(u);
}
function speakEN(t){
  const sel=document.getElementById('voiceEn');
  const en = speechSynthesis.getVoices().find(v=>v.name===sel.value) || pickWhitelistedEnglishVoices()[0] || null;
  const u=new SpeechSynthesisUtterance(t);
  if(en) u.voice=en;
  u.lang=(en && en.lang) ? en.lang : 'en-US';
  u.rate = rate();
  if(document.getElementById('cartoonEn').checked) u.pitch=1.6;
  speechSynthesis.speak(u);
}
function getFavs(){ try{ return JSON.parse(localStorage.getItem('favorites')||'[]'); }catch(e){ return []; } }
function setFavs(a){ localStorage.setItem('favorites', JSON.stringify(a)); }
function render(){
  const list = document.getElementById('list');
  list.innerHTML = "";
  const data = getFavs();
  if(!data.length){ list.innerHTML = "<div class='small'>å°šç„¡æ”¶è—ï¼Œè«‹åˆ°ã€ŒAI ç¿»è­¯ã€é æŒ‰æ˜Ÿè™ŸåŠ å…¥ã€‚</div>"; return; }
  data.forEach((it, idx)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div class="title">ğŸ‡°ğŸ‡· ${it.ko}</div>
      <div class="eng">ğŸ‡¬ğŸ‡§ ${it.en}</div>
      <div class="zh">ğŸ‡¹ğŸ‡¼ ${it.zh}</div>
      <div class="ops">
        <button class="btn" data-ko="${it.ko}">éŸ“æ–‡æœ—è®€</button>
        <button class="btn" data-en="${it.en}">è‹±æ–‡æœ—è®€</button>
        <button class="btn del star on" data-del="${idx}" title="å¾æ”¶è—ç§»é™¤"><img src='icons/toboki-yellow.svg' alt='ç§»é™¤æ”¶è—'></button>
      </div>
    `;
    list.appendChild(div);
  });
}
document.addEventListener('click', e=>{
  const ko=e.target.getAttribute('data-ko'); if(ko){ speakEN(""); speakKO(ko); return; }
  const en=e.target.getAttribute('data-en'); if(en){ speakEN(en); return; }
  const di=e.target.getAttribute('data-del'); if(di!==null){ const arr=getFavs(); arr.splice(parseInt(di),1); setFavs(arr); render(); }
});
window.speechSynthesis.onvoiceschanged = ()=>populateEnglishVoices();
populateEnglishVoices();
render();
</script>

</body>
</html>