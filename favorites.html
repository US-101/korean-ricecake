<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,minimum-scale=1,user-scalable=yes,viewport-fit=cover">

<!-- PWA 和 iOS 兼容性改進 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-touch-fullscreen" content="yes">
<meta name="format-detection" content="telephone=no">

<!-- 防止 iOS 自動縮放 -->
<meta name="apple-mobile-web-app-title" content="韓語年糕">

<!-- PWA 主題色彩 -->
<meta name="theme-color" content="#F3FCFD">
<meta name="msapplication-navbutton-color" content="#F3FCFD">
<meta name="apple-mobile-web-app-status-bar-style" content="light-content">

<!-- iOS Safari 特殊處理 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<title>★ 收藏</title>
<link rel="stylesheet" href="styles.css" />
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<link rel="apple-touch-startup-image" href="splash.png" />
<script>
  // 替換所有 HTML 文件中的 Service Worker 註冊代碼
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('./sw.js', {
          scope: './',
          updateViaCache: 'none' // 確保 SW 更新
        });
        
        console.log('ServiceWorker registered successfully');
        
        // PWA 安裝提示處理
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          window.deferredPrompt = e;
        });
        
        // PWA 模式檢測
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
          // PWA 模式下的特殊處理
          document.body.classList.add('pwa-mode');
          
          // 確保輸入框在 PWA 模式下正常工作
          setTimeout(() => {
            const textareas = document.querySelectorAll('textarea');
            const inputs = document.querySelectorAll('input[type="text"], input[type="search"]');
            
            [...textareas, ...inputs].forEach(element => {
              element.style.webkitAppearance = 'none';
              element.style.webkitUserSelect = 'text';
              element.style.webkitTouchCallout = 'default';
            });
          }, 1000);
        }
        
      } catch (error) {
        console.log('ServiceWorker registration failed: ', error);
      }
    });
  }
</script>

</head>
<body>

<header>
  <div class="wrap">
    <h1>★ 收藏</h1>
    <div class="nav">
      <a href="index.html">發音練習</a>
      <a href="travel.html">旅遊會話</a>
      <a href="translate.html">AI 翻譯</a>
      <a class="active" href="favorites.html">★ 收藏</a>
    </div>
    <div class="controls">
      <label>播放速度
        <select id="rate" class="select">
          <option value="0.5">×0.5</option>
          <option value="0.75" selected>×0.75</option>
          <option value="1.0">×1.0</option>
        </select>
      </label>
      <label class="control"><input type="checkbox" id="cartoonEn" />英文卡通模式</label>
      <label>英文聲音
        <select id="voiceEn" class="select"><option>載入中…</option></select>
      </label>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="legend">已收藏句子</div>
  <div id="list" class="list"></div>
</main>

<footer>資料保存在本機瀏覽器（localStorage）。</footer>

<script>
const EN_WHITELIST = [
  {name:"Daniel",   lang:"en-GB"},
  {name:"Moira",    lang:"en-IE"},
  {name:"Samantha", lang:"en-AU"},
  {name:"Tessa",    lang:"en-ZA"}
];
function pickWhitelistedEnglishVoices(){
  const all = speechSynthesis.getVoices();
  const ok = [];
  EN_WHITELIST.forEach(w=>{
    const v = all.find(x => x.name===w.name && (x.lang||"").toLowerCase().startsWith(w.lang.toLowerCase()));
    if(v) ok.push(v);
  });
  return ok;
}
function populateEnglishVoices(){
  const sel = document.getElementById('voiceEn');
  sel.innerHTML = "";
  const list = pickWhitelistedEnglishVoices();
  if(!list.length){ sel.innerHTML = "<option>未找到：Daniel / Moira / Samantha / Tessa</option>"; return; }
  list.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = v.name + " ("+v.lang+")";
    sel.appendChild(opt);
    if(i===0) sel.value = v.name;
  });
  const stored = localStorage.getItem('voiceEnName');
  if(stored && list.some(v=>v.name===stored)) sel.value = stored;
  sel.addEventListener('change',()=>localStorage.setItem('voiceEnName', sel.value));
}
function rate(){ return parseFloat(document.getElementById('rate').value||'0.75'); }
function speakKO(t){
  const u = new SpeechSynthesisUtterance(t);
  const ko = speechSynthesis.getVoices().find(v => /ko/i.test(v.lang||""));
  if(ko) u.voice = ko;
  u.lang='ko-KR'; u.rate = rate();
  if(document.getElementById('cartoonEn').checked) u.pitch=1.6;
  speechSynthesis.speak(u);
}
function speakEN(t){
  const sel=document.getElementById('voiceEn');
  const en = speechSynthesis.getVoices().find(v=>v.name===sel.value) || pickWhitelistedEnglishVoices()[0] || null;
  const u=new SpeechSynthesisUtterance(t);
  if(en) u.voice=en;
  u.lang=(en && en.lang) ? en.lang : 'en-US';
  u.rate = rate();
  if(document.getElementById('cartoonEn').checked) u.pitch=1.6;
  speechSynthesis.speak(u);
}
function getFavs(){ try{ return JSON.parse(localStorage.getItem('favorites')||'[]'); }catch(e){ return []; } }
function setFavs(a){ localStorage.setItem('favorites', JSON.stringify(a)); }
function render(){
  const list = document.getElementById('list');
  list.innerHTML = "";
  const data = getFavs();
  if(!data.length){ list.innerHTML = "<div class='small'>尚無收藏，請到「AI 翻譯」頁按星號加入。</div>"; return; }
  data.forEach((it, idx)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div class="title">🇰🇷 ${it.ko}</div>
      <div class="eng">🇬🇧 ${it.en}</div>
      <div class="zh">🇹🇼 ${it.zh}</div>
      <div class="ops">
        <button class="btn" data-ko="${it.ko}">韓文朗讀</button>
        <button class="btn" data-en="${it.en}">英文朗讀</button>
        <button class="btn del star on" data-del="${idx}" title="從收藏移除"><img src='icons/toboki-yellow.svg' alt='移除收藏'></button>
      </div>
    `;
    list.appendChild(div);
  });
}
document.addEventListener('click', e=>{
  const ko=e.target.getAttribute('data-ko'); if(ko){ speakEN(""); speakKO(ko); return; }
  const en=e.target.getAttribute('data-en'); if(en){ speakEN(en); return; }
  const di=e.target.getAttribute('data-del'); if(di!==null){ const arr=getFavs(); arr.splice(parseInt(di),1); setFavs(arr); render(); }
});
window.speechSynthesis.onvoiceschanged = ()=>populateEnglishVoices();
populateEnglishVoices();
render();
</script>

</body>
</html>