<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>韓語年糕｜實時翻譯</title><link rel="manifest" href="manifest.json"><link rel="stylesheet" href="styles.css">
<link rel="apple-touch-icon" href="icons/icon-512.png"><meta name="theme-color" content="#F3FCFD" /><meta name="apple-mobile-web-app-status-bar-style" content="default" /><meta name="apple-mobile-web-app-capable" content="yes" /><link rel="apple-touch-startup-image" href="splash.png" /><script>
  // 替換所有 HTML 文件中的 Service Worker 註冊代碼
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('./sw.js', {
          scope: './',
          updateViaCache: 'none' // 確保 SW 更新
        });
        
        console.log('ServiceWorker registered successfully');
        
        // PWA 安裝提示處理
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          window.deferredPrompt = e;
        });
        
        // PWA 模式檢測
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
          // PWA 模式下的特殊處理
          document.body.classList.add('pwa-mode');
          
          // 確保輸入框在 PWA 模式下正常工作
          setTimeout(() => {
            const textareas = document.querySelectorAll('textarea');
            const inputs = document.querySelectorAll('input[type="text"], input[type="search"]');
            
            [...textareas, ...inputs].forEach(element => {
              element.style.webkitAppearance = 'none';
              element.style.webkitUserSelect = 'text';
              element.style.webkitTouchCallout = 'default';
            });
          }, 1000);
        }
        
      } catch (error) {
        console.log('ServiceWorker registration failed: ', error);
      }
    });
  }
</script>

<style>
/* PWA 模式下的 textarea 修復 */
.input-container {
  position: relative;
  width: 100%;
  z-index: 1;
}

#in {
  width: 100%;
  min-height: 120px;
  border: 2px solid #cfe7e7;
  border-radius: 14px;
  padding: 12px;
  font-size: 16px;
  background: #fff;
  resize: vertical;
  font-family: ui-rounded, ui-sans-serif, -apple-system, 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
  line-height: 1.4;
  box-sizing: border-box;
  
  /* PWA 模式關鍵修復 */
  -webkit-appearance: none;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: text;
  -webkit-touch-callout: default;
  -moz-appearance: none;
  appearance: none;
  
  /* 強制觸發鍵盤的屬性 */
  inputmode: text;
  autocapitalize: sentences;
  autocomplete: off;
  autocorrect: off;
  spellcheck: false;
  
  /* 確保在 PWA 中正確顯示 */
  position: relative;
  z-index: 2;
  cursor: text;
  
  /* 防止縮放 */
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

#in:focus {
  outline: none;
  border-color: #8ECFD0;
  box-shadow: 0 0 0 3px rgba(142, 207, 208, 0.2);
  
  /* PWA 焦點狀態增強 */
  -webkit-tap-highlight-color: rgba(142, 207, 208, 0.2);
  position: relative;
  z-index: 3;
}

/* PWA 模式專用修復 */
@media all and (display-mode: standalone) {
  #in {
    /* 在 PWA 模式下使用更積極的設置 */
    -webkit-appearance: textfield !important;
    -moz-appearance: textfield !important;
    appearance: textfield !important;
    
    /* 確保觸控事件不被阻攔 */
    pointer-events: auto;
    touch-action: manipulation;
    
    /* 強制文字選擇 */
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    user-select: text !important;
  }
  
  /* PWA 模式下的容器調整 */
  .input-container {
    /* 確保容器不會干擾觸控 */
    pointer-events: none;
  }
  
  .input-container #in {
    pointer-events: auto;
  }
}

/* iOS PWA 特殊處理 */
@supports (-webkit-touch-callout: none) {
  @media all and (display-mode: standalone) {
    #in {
      font-size: 16px !important;
      -webkit-text-size-adjust: 100% !important;
      
      /* iOS PWA 鍵盤觸發關鍵設置 */
      -webkit-appearance: none !important;
      -webkit-user-select: text !important;
      -webkit-touch-callout: default !important;
      
      /* 確保能接收觸控事件 */
      touch-action: manipulation !important;
      cursor: text !important;
    }
  }
}

.wrap {
  touch-action: manipulation;
}

.pill {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  -webkit-user-select: none;
}
</style>
</head><body>
<header class="topbar"><div class="bar"><h1 class="title"><img src="icons/p3.svg" alt=""></h1></div></header>
<div class="appbar"><div class="row" style="justify-content:space-between;gap:12px;max-width:540px;margin:0 auto;padding:12px 16px 6px 16px">
  <div style="display:flex;gap:12px">
    <span id="voiceEn" class="pill">Moira</span>
  </div>
  <div style="display:flex;gap:8px">
    <span id="mickey" class="pill"><img src="icons/micky.svg" width="20" height="20" alt=""></span>
    <span class="pill amber speed">x0.75</span>
  </div>
</div>
<div class="row" style="justify-content:flex-start;max-width:540px;margin:0 auto;padding:0 16px 8px 16px">
  <div style="font-size:12px;color:#97a1a6">英語：點選名字可切換人物 · 영어: 이름 선택 시 음성 전환<br>按下<img src="icons/micky.svg" style="width:12px;height:12px;vertical-align:middle;margin:0 2px;filter:invert(60%) sepia(5%) saturate(300%) hue-rotate(180deg) brightness(95%) contrast(85%);">切換成米奇模式 · <img src="icons/micky.svg" style="width:12px;height:12px;vertical-align:middle;margin:0 2px;filter:invert(60%) sepia(5%) saturate(300%) hue-rotate(180deg) brightness(95%) contrast(85%);">을 누르면 미키 모드로 바뀝니다</div>
</div></div>
<main class="wrap">
  
  <div class="input-container">
    <textarea id="in" placeholder="請輸入要翻譯的句子（支持中文、韓文、英文）…" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
  </div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="pill teal" id="btnGo">翻 譯</button>
  </div>
  <div class="result list" id="result"></div>
</main>
<nav class="tabbar"><div class="in"><a class='' href='index.html'><span class='ico'><img src='icons/p1.svg' alt=''></span>發音練習</a><a class='' href='travel.html'><span class='ico'><img src='icons/p2.svg' alt=''></span>旅行會話</a><a class='active' href='translate.html'><span class='ico'><img src='icons/p3.svg' alt=''></span>實時翻譯</a><a class='' href='history.html'><span class='ico'><img src='icons/p4.svg' alt=''></span>歷史紀錄</a></div></nav>

<!-- 統一的收藏彈窗樣式 -->
<section class="modal" id="pickFolder" style="display:none"><div class="sheet">
  <button class="close" id="pickClose" aria-label="關閉">✕</button>
  <h3 class="title" style="text-align:center;margin:6px 0 12px 0;color:#78bfc0">收藏到哪個資料夾？</h3>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="pill" data-folder="餐廳">餐 廳</button>
    <button class="pill" data-folder="購物">購 物</button>
    <button class="pill" data-folder="問路">問 路</button>
    <button class="pill" data-folder="其他">其 他</button>
  </div>
</div></section>

<!-- 確認刪除彈窗 -->
<section class="modal" id="confirmDelete" style="display:none"><div class="sheet">
  <button class="close" id="confirmClose" aria-label="關閉">✕</button>
  <h3 class="title" style="text-align:center;margin:6px 0 12px 0;color:#78bfc0">確定要從收藏移除嗎？</h3>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="pill" id="confirmYes">確 定</button>
    <button class="pill" id="confirmNo">取 消</button>
  </div>
</div></section>

<script>
const EN=["Daniel","Moira","Samantha","Tessa"]; 
let VOICE_EN_NAME=localStorage.getItem('voiceEnName')||'Moira';

function availableEnVoices(){ 
  const all=speechSynthesis.getVoices(); 
  return EN.map(n=>all.find(v=>v.name===n)).filter(Boolean); 
}

function updateVoiceUI(){ 
  const el=document.getElementById('voiceEn'); 
  if(el) el.textContent=VOICE_EN_NAME; 
}

function ensureVoice(){ 
  const avail=availableEnVoices().map(v=>v.name); 
  if(!avail.includes(VOICE_EN_NAME) && avail.length){ 
    VOICE_EN_NAME=avail[0]; 
    localStorage.setItem('voiceEnName', VOICE_EN_NAME); 
  } 
  updateVoiceUI(); 
}

window.speechSynthesis.onvoiceschanged=()=>{ 
  ensureVoice(); 
};

function loadMickeyState(){ 
  const mickeyState = localStorage.getItem('mickeyMode') === 'true'; 
  const mickey = document.getElementById('mickey'); 
  if(mickeyState && mickey) mickey.classList.add('on'); 
}

function saveMickeyState(isOn){ 
  localStorage.setItem('mickeyMode', isOn.toString()); 
}

// 修正 Mickey 按鈕事件處理
document.getElementById('mickey').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  this.classList.toggle('on'); 
  saveMickeyState(this.classList.contains('on'));
});

// PWA 模式下的鍵盤修復
const textarea = document.getElementById('in');

// 檢測是否在 PWA 模式
const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
              window.navigator.standalone === true ||
              document.referrer.includes('android-app://');

// PWA 模式下的特殊處理
if (isPWA) {
  // 方法1：強制觸發輸入框
  textarea.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // 強制獲得焦點
    this.focus();
    
    // 確保鍵盤彈出
    setTimeout(() => {
      this.click();
    }, 50);
    
    setTimeout(() => {
      this.focus();
    }, 100);
  }, { passive: false });

  // 方法2：使用 click 事件作為後備
  textarea.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    this.focus();
    
    // 觸發選擇文字來強制鍵盤彈出
    setTimeout(() => {
      this.selectionStart = this.value.length;
      this.selectionEnd = this.value.length;
    }, 100);
  });

  // 方法3：監聽 input 事件確保功能正常
  textarea.addEventListener('input', function(e) {
    // 確保 PWA 中能正常輸入
    console.log('Input working in PWA mode');
  });

} else {
  // Safari 瀏覽器模式的處理
  textarea.addEventListener('touchstart', function(e) {
    setTimeout(() => {
      this.focus();
    }, 100);
  });

  textarea.addEventListener('focus', function(e) {
    setTimeout(() => {
      this.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  });
}

let RATE=parseFloat(localStorage.getItem('playbackRate')||'0.75'); 
const SPEEDS=[0.5,0.75,1.0];

function updateSpeedUI(){ 
  document.querySelectorAll('.speed').forEach(el=>{ 
    el.textContent='x'+RATE.toFixed(2).replace(/\.00$/,''); 
  }); 
}

function cycleSpeed(){ 
  const i=SPEEDS.indexOf(RATE); 
  RATE=SPEEDS[(i+1)%SPEEDS.length]; 
  localStorage.setItem('playbackRate', RATE.toString()); 
  updateSpeedUI(); 
}

function speakKO(t){ 
  const u=new SpeechSynthesisUtterance(t);
  u.lang='ko-KR';
  u.rate=RATE; 
  const v=speechSynthesis.getVoices().find(v=>/ko/i.test(v.lang||'')); 
  if(v) u.voice=v; 
  if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; 
  speechSynthesis.speak(u);
} 

function speakEN(t){ 
  const v=speechSynthesis.getVoices().find(v=>v.name===VOICE_EN_NAME)||speechSynthesis.getVoices().find(v=>/en/i.test(v.lang||'')); 
  const u=new SpeechSynthesisUtterance(t); 
  if(v) u.voice=v; 
  u.rate=RATE; 
  if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; 
  speechSynthesis.speak(u);
} 

async function tMM(q,from,to){ 
  const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${from}|${to}`); 
  const j=await r.json(); 
  return j?.responseData?.translatedText || ""; 
}

async function tLibre(q,from,to){ 
  const r=await fetch("https://libretranslate.de/translate", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({q,source:from,target:to})
  }); 
  const j=await r.json(); 
  return j?.translatedText || ""; 
}

async function doTranslate(text){ 
  let ko="",en="",zh=""; 
  
  // 檢測輸入語言
  const isKorean = /[\uAC00-\uD7AF]/.test(text); // 韓文字符範圍
  const isChinese = /[\u4E00-\u9FFF]/.test(text); // 中文字符範圍
  
  if(isKorean) {
    // 韓文輸入：翻譯成中文和英文
    try{zh=await tMM(text,"ko","zh-TW");}catch(e){}
    try{en=await tMM(text,"ko","en");}catch(e){}
    if(!zh){try{zh=await tLibre(text,"ko","zh");}catch(e){}}
    if(!en){try{en=await tLibre(text,"ko","en");}catch(e){}}
    return {ko:text,en,zh};
  } else if(isChinese) {
    // 中文輸入：翻譯成韓文和英文
    try{en=await tMM(text,"zh-TW","en");}catch(e){}
    try{ko=await tMM(text,"zh-TW","ko");}catch(e){}
    if(!en){try{en=await tLibre(text,"zh","en");}catch(e){}}
    if(!ko){try{ko=await tLibre(text,"zh","ko");}catch(e){}}
    return {ko,en,zh:text};
  } else {
    // 英文或其他語言輸入：翻譯成中文和韓文
    try{zh=await tMM(text,"en","zh-TW");}catch(e){}
    try{ko=await tMM(text,"en","ko");}catch(e){}
    if(!zh){try{zh=await tLibre(text,"en","zh");}catch(e){}}
    if(!ko){try{ko=await tLibre(text,"en","ko");}catch(e){}}
    return {ko,en:text,zh};
  }
}

function hist(){ 
  try{ 
    return JSON.parse(localStorage.getItem('history')||'[]'); 
  }catch(e){ 
    return []; 
  } 
}

function saveHist(entry){ 
  const h=hist(); 
  const dedup=h.filter(it=>!(it.zh===entry.zh && it.en===entry.en && it.ko===entry.ko)); 
  dedup.unshift(Object.assign({ts:Date.now()}, entry)); 
  localStorage.setItem('history', JSON.stringify(dedup.slice(0,10))); 
}

function favs(){ 
  try{ 
    return JSON.parse(localStorage.getItem('favorites')||'[]'); 
  }catch(e){ 
    return []; 
  } 
}

function isFav(ko, en, zh){ 
  return favs().some(f=>f.ko===ko && f.en===en && f.zh===zh); 
}

function renderCard(text,out,starId){ 
  const card=document.createElement('div'); 
  const isFavorited = isFav(out.ko, out.en, out.zh || text);
  card.className='card'; 
  card.innerHTML=`
    <div class='card-inner'>
      <div class='ko'>${out.ko||"(韓文失敗)"}</div>
      <div class='trans'>
        <div class='en'>${out.en||"(英文失敗)"}</div>
        <div class='zh'>${out.zh||text}</div>
      </div>
      <div class='act'>
        <button class='pill' data-ko='${out.ko}'>韓</button>
        <button class='pill' data-en='${out.en}'>英</button>
        <span class='star ${isFavorited?'on':''}' id='${starId}' title='${isFavorited?'已收藏':'收藏'}'><img src='icons/${isFavorited?'toboki-yellow':'toboki'}.svg' alt='${isFavorited?'已收藏':'收藏'}'></span>
      </div>
    </div>
  `; 
  const result=document.getElementById('result'); 
  result.innerHTML=''; 
  result.appendChild(card); 
}

async function translateAndMaybeSave(save){ 
  const btn=document.getElementById('btnGo'); 
  const text=(document.getElementById('in').value||'').trim(); 
  if(!text) return; 
  
  const old=btn.innerHTML; 
  btn.classList.add('pulse','busy','amber-temp'); 
  btn.textContent='翻 譯 中'; 
  
  try {
    const out=await doTranslate(text); 
    renderCard(text,out,'fstar'); 
    if(save){ 
      saveHist({ko:out.ko,en:out.en,zh:out.zh||text}); 
    } 
    const card=document.querySelector('.card'); 
    if(card) card.classList.add('flash'); 
    
    setTimeout(()=>{ 
      if(card) card.classList.remove('flash'); 
    }, 400); 
  } catch (error) {
    console.error('Translation error:', error);
    // 顯示錯誤訊息
    const result=document.getElementById('result'); 
    result.innerHTML='<div class="card"><div class="card-inner"><div class="ko" style="color:red;">翻譯失敗，請檢查網路連線後重試</div></div></div>';
  } finally {
    setTimeout(()=>{ 
      btn.classList.remove('pulse','busy','amber-temp'); 
      btn.textContent='翻 譯'; 
    }, 400);
  }
}

// 修正翻譯按鈕事件
document.getElementById('btnGo').addEventListener('click', function(e) {
  e.preventDefault();
  translateAndMaybeSave(true);
});

// 添加 Enter 鍵翻譯功能
document.getElementById('in').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    translateAndMaybeSave(true);
  }
});
 
function cycleVoice(){ 
  const avail=availableEnVoices().map(v=>v.name); 
  if(!avail.length) return; 
  const idx=avail.indexOf(VOICE_EN_NAME); 
  VOICE_EN_NAME=avail[(idx+1)%avail.length]; 
  localStorage.setItem('voiceEnName', VOICE_EN_NAME); 
  updateVoiceUI(); 
}

let PENDING_STAR=null; // {ko,en,zh,el}
let PENDING_DELETE=null; // {ko,en,zh,el}

document.addEventListener('click', (e)=>{ 
  if(e.target.closest('#voiceEn')) return cycleVoice(); 
  if(e.target.closest('.speed')) return cycleSpeed(); 
  
  if(e.target.matches('[data-ko]')){ 
    e.target.classList.add('pulse','amber-temp'); 
    setTimeout(()=>e.target.classList.remove('pulse','amber-temp'),350); 
    return speakKO(e.target.getAttribute('data-ko')); 
  } 
  
  if(e.target.matches('[data-en]')){ 
    e.target.classList.add('pulse','amber-temp'); 
    setTimeout(()=>e.target.classList.remove('pulse','amber-temp'),350); 
    return speakEN(e.target.getAttribute('data-en')); 
  }

  // 點擊星號收藏/取消收藏
  const starElement = e.target.closest('#fstar');
  if(starElement){ 
    const c=starElement.closest('.card'); 
    const ko=c.querySelector('.ko').textContent;
    const en=c.querySelector('.en').textContent;
    const zh=c.querySelector('.zh').textContent;
    
    if(starElement.classList.contains('on')){ 
      // 已收藏，顯示確認刪除
      PENDING_DELETE={ko, en, zh, el:starElement};
      document.getElementById('confirmDelete').style.display='flex'; 
    } else { 
      // 未收藏，顯示選擇資料夾
      PENDING_STAR={ko, en, zh, el:starElement};
      document.getElementById('pickFolder').style.display='flex'; 
    }
    return; 
  }

  // 選擇收藏夾
  if(e.target.matches('[data-folder]')){ 
    const folder=e.target.getAttribute('data-folder'); 
    if(PENDING_STAR){ 
      const favsList=JSON.parse(localStorage.getItem('favorites')||'[]'); 
      favsList.unshift({
        ko:PENDING_STAR.ko,
        en:PENDING_STAR.en,
        zh:PENDING_STAR.zh,
        folder,
        ts:Date.now()
      }); 
      localStorage.setItem('favorites', JSON.stringify(favsList)); 
      PENDING_STAR.el.querySelector('img').src = 'icons/toboki-yellow.svg';
      PENDING_STAR.el.classList.add('on'); 
      PENDING_STAR.el.title='已收藏';
      PENDING_STAR=null; 
    } 
    document.getElementById('pickFolder').style.display='none'; 
    return; 
  }

  // 確認刪除
  if(e.target.id==='confirmYes' && PENDING_DELETE){ 
    const favsList=JSON.parse(localStorage.getItem('favorites')||'[]'); 
    const filtered = favsList.filter(f=>!(f.ko===PENDING_DELETE.ko && f.en===PENDING_DELETE.en && f.zh===PENDING_DELETE.zh)); 
    localStorage.setItem('favorites', JSON.stringify(filtered)); 
    PENDING_DELETE.el.querySelector('img').src = 'icons/toboki.svg';
    PENDING_DELETE.el.classList.remove('on'); 
    PENDING_DELETE.el.title='收藏';
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }
  
  if(e.target.id==='confirmNo' || e.target.id==='confirmClose'){ 
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }

  // 點擊彈窗背景關閉
  if(e.target.id==='pickFolder') { 
    PENDING_STAR = null;
    document.getElementById('pickFolder').style.display='none'; 
    return; 
  }
  
  if(e.target.id==='confirmDelete') { 
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }

  // 防止點擊彈窗內容區域時關閉
  if(e.target.closest('#pickFolder .sheet') && !e.target.matches('[data-folder]') && !e.target.matches('#pickClose')){ 
    return; 
  }
  
  if(e.target.closest('#confirmDelete .sheet') && !e.target.matches('#confirmYes, #confirmNo')){ 
    return; 
  }
});

// 關閉按鈕
document.getElementById('pickClose').addEventListener('click',()=>{ 
  PENDING_STAR = null;
  document.getElementById('pickFolder').style.display='none'; 
});

ensureVoice(); 
updateSpeedUI();
loadMickeyState();
</script></body></html>