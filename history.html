<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
<title>éŸ“èªå¹´ç³•ï½œæ­·å²ç´€éŒ„</title><link rel="manifest" href="manifest.json"><link rel="stylesheet" href="styles.css">
<link rel="apple-touch-icon" href="icons/icon-512.png"><meta name="theme-color" content="#F3FCFD" /><meta name="apple-mobile-web-app-status-bar-style" content="default" /><meta name="apple-mobile-web-app-capable" content="yes" /><link rel="apple-touch-startup-image" href="splash.png" /><script>if('serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));}</script></head><body>
<header class="topbar"><div class="bar"><h1 class="title"><img src="icons/p4.svg" alt="æ­·å²ç´€éŒ„"></h1></div></header>

<div class="appbar"><div class="row" style="justify-content:space-between;gap:12px;max-width:540px;margin:0 auto;padding:12px 16px 6px 16px">
  <div style="display:flex;gap:12px">
    <span id="voiceEn" class="pill">Moira</span>
  </div>
  <div style="display:flex;gap:8px">
    <span id="mickey" class="pill"><img src="icons/micky.svg" width="20" height="20" alt=""></span>
    <span class="pill amber speed">x0.75</span>
  </div>
</div>
<div class="row" style="justify-content:flex-start;max-width:540px;margin:0 auto;padding:0 16px 8px 16px">
  <div style="font-size:12px;color:#97a1a6">è‹±èªï¼šé»é¸åå­—å¯åˆ‡æ›äººç‰© Â· ì˜ì–´: ì´ë¦„ ì„ íƒ ì‹œ ìŒì„± ì „í™˜<br>æŒ‰ä¸‹<img src="icons/micky.svg" style="width:12px;height:12px;vertical-align:middle;margin:0 2px;filter:invert(60%) sepia(5%) saturate(300%) hue-rotate(180deg) brightness(95%) contrast(85%);">åˆ‡æ›æˆç±³å¥‡æ¨¡å¼ Â· <img src="icons/micky.svg" style="width:12px;height:12px;vertical-align:middle;margin:0 2px;filter:invert(60%) sepia(5%) saturate(300%) hue-rotate(180deg) brightness(95%) contrast(85%);">ì„ ëˆ„ë¥´ë©´ ë¯¸í‚¤ ëª¨ë“œë¡œ ë°”ë€ë‹ˆë‹¤</div>
</div></div>

<main class="wrap"><div id="box" class="list"></div></main>

<nav class="tabbar"><div class="in">
<a class='' href='index.html'><span class='ico'><img src='icons/p1.svg' alt=''></span>ç™¼éŸ³ç·´ç¿’</a>
<a class='' href='travel.html'><span class='ico'><img src='icons/p2.svg' alt=''></span>æ—…è¡Œæœƒè©±</a>
<a class='' href='translate.html'><span class='ico'><img src='icons/p3.svg' alt=''></span>å¯¦æ™‚ç¿»è­¯</a>
<a class='active' href='history.html'><span class='ico'><img src='icons/p4.svg' alt=''></span>æ­·å²ç´€éŒ„</a>
</div></nav>

<!-- çµ±ä¸€çš„æ”¶è—å½ˆçª—æ¨£å¼ -->
<section class="modal" id="pickFolderH" style="display:none"><div class="sheet">
  <button class="close" id="pickCloseH" aria-label="é—œé–‰">âœ•</button>
  <h3 class="title" style="text-align:center;margin:6px 0 12px 0;color:#78bfc0">æ–°å¢è‡³æ”¶è—å¤¾</h3>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="pill" data-folder="é¤å»³">é¤ å»³</button>
    <button class="pill" data-folder="è³¼ç‰©">è³¼ ç‰©</button>
    <button class="pill" data-folder="å•è·¯">å• è·¯</button>
    <button class="pill" data-folder="å…¶ä»–">å…¶ ä»–</button>
  </div>
</div></section>

<!-- ç¢ºèªåˆªé™¤å½ˆçª— -->
<section class="modal" id="confirmDelete" style="display:none"><div class="sheet">
  <button class="close" id="confirmClose" aria-label="é—œé–‰">âœ•</button>
  <h3 class="title" style="text-align:center;margin:6px 0 12px 0;color:#78bfc0">ç¢ºå®šè¦å¾æ”¶è—ç§»é™¤å—ï¼Ÿ</h3>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="pill" id="confirmYes">ç¢º å®š</button>
    <button class="pill" id="confirmNo">å– æ¶ˆ</button>
  </div>
</div></section>

<script>
const EN=["Daniel","Moira","Samantha","Tessa"];
let RATE=parseFloat(localStorage.getItem('playbackRate')||'0.75'); const SPEEDS=[0.5,0.75,1.0];
let VOICE_EN_NAME = localStorage.getItem('voiceEnName') || 'Moira';

function updateVoiceUI(){ 
  const el=document.getElementById('voiceEn'); 
  if(el) el.textContent = VOICE_EN_NAME; 
}

function availableEnVoices(){ 
  const all=speechSynthesis.getVoices(); 
  return EN.map(n=>all.find(v=>v.name===n)).filter(Boolean); 
}

function ensureVoice(){ 
  const avail=availableEnVoices().map(v=>v.name); 
  if(!avail.includes(VOICE_EN_NAME) && avail.length){ 
    VOICE_EN_NAME = avail[0]; 
    localStorage.setItem('voiceEnName', VOICE_EN_NAME); 
  }
  updateVoiceUI(); 
}

function cycleVoice(){ 
  const avail=availableEnVoices().map(v=>v.name); 
  if(!avail.length) return; 
  const idx=avail.indexOf(VOICE_EN_NAME); 
  VOICE_EN_NAME = avail[(idx+1)%avail.length]; 
  localStorage.setItem('voiceEnName', VOICE_EN_NAME); 
  updateVoiceUI(); 
}

function updateSpeedUI(){ 
  document.querySelectorAll('.speed').forEach(el=>{ 
    el.textContent='x'+RATE.toFixed(2).replace(/\.00$/,''); 
  }); 
}

function cycleSpeed(){ 
  const i=SPEEDS.indexOf(RATE); 
  RATE=SPEEDS[(i+1)%SPEEDS.length]; 
  localStorage.setItem('playbackRate', RATE.toString());
  updateSpeedUI(); 
}

function speakKO(t){ 
  const u=new SpeechSynthesisUtterance(t);
  u.lang='ko-KR';
  u.rate=RATE; 
  const v=speechSynthesis.getVoices().find(v=>/ko/i.test(v.lang||'')); 
  if(v) u.voice=v; 
  if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6;
  speechSynthesis.speak(u);
}

function speakEN(t){ 
  const v=speechSynthesis.getVoices().find(v=>v.name===VOICE_EN_NAME)||speechSynthesis.getVoices().find(v=>/en/i.test(v.lang||'')); 
  const u=new SpeechSynthesisUtterance(t); 
  if(v) u.voice=v; 
  u.rate=RATE; 
  if(document.getElementById('mickey').classList.contains('on')) u.pitch=1.6; 
  speechSynthesis.speak(u);
}

function hist(){ 
  try{ 
    return JSON.parse(localStorage.getItem('history')||'[]'); 
  }catch(e){ 
    return []; 
  } 
}

function favs(){ 
  try{ 
    return JSON.parse(localStorage.getItem('favorites')||'[]'); 
  }catch(e){ 
    return []; 
  } 
}

function isFav(it){ 
  return favs().some(f=>f.ko===it.ko && f.en===it.en && f.zh===it.zh); 
}

function render(){ 
  const box=document.getElementById('box'); 
  box.innerHTML=''; 
  const H=hist(); 
  
  if(!H.length){ 
    box.innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-text">å°šç„¡æ­·å²ç´€éŒ„</div>
        <div class="empty-subtext">è«‹åˆ°ã€Œå¯¦æ™‚ç¿»è­¯ã€é é¢é–‹å§‹ç¿»è­¯</div>
      </div>
    `; 
    return; 
  } 
  
  H.forEach(it=>{ 
    const starred=isFav(it); 
    const c=document.createElement('div'); 
    c.className='card'; 
    c.innerHTML=`
      <div class='card-inner'>
        <div class='ko'>${it.ko}</div>
        <div class='trans'>
          <div class='en'>${it.en}</div>
          <div class='zh'>${it.zh}</div>
        </div>
        <div class='act'>
          <button class='pill' data-ko='${it.ko}'>éŸ“</button>
          <button class='pill' data-en='${it.en}'>è‹±</button>
          <span class='star ${starred?'on':''}' data-star='1'><img src='icons/${starred?'toboki-yellow':'toboki'}.svg' alt='${starred?'å·²æ”¶è—':'æ”¶è—'}'></span>
        </div>
      </div>
    `; 
    box.appendChild(c); 
  }); 
}

function loadMickeyState(){ const mickeyState = localStorage.getItem('mickeyMode') === 'true'; const mickey = document.getElementById('mickey'); if(mickeyState && mickey) mickey.classList.add('on'); }
function saveMickeyState(isOn){ localStorage.setItem('mickeyMode', isOn.toString()); }

let PENDING_H=null;
let PENDING_DELETE=null;

document.addEventListener('click',(e)=>{ 
  if(e.target.closest('#voiceEn')) return cycleVoice();
  if(e.target.closest('.speed')) return cycleSpeed();
  if(e.target.closest('#mickey')) {
    const mickey = e.target.closest('#mickey');
    mickey.classList.toggle('on');
    saveMickeyState(mickey.classList.contains('on'));
    return;
  }
  
  if(e.target.matches('[data-ko]')) return speakKO(e.target.getAttribute('data-ko')); 
  if(e.target.matches('[data-en]')) return speakEN(e.target.getAttribute('data-en')); 
  
  const starElement = e.target.closest('[data-star]');
  if(starElement){ 
    const c=starElement.closest('.card'); 
    const ko=c.querySelector('.ko').textContent;
    const en=c.querySelector('.en').textContent;
    const zh=c.querySelector('.zh').textContent;
    
    if(starElement.classList.contains('on')){ 
      // å·²æ”¶è—ï¼Œé¡¯ç¤ºç¢ºèªåˆªé™¤
      PENDING_DELETE={ko, en, zh, el:starElement};
      document.getElementById('confirmDelete').style.display='flex'; 
    } else { 
      // æœªæ”¶è—ï¼Œé¡¯ç¤ºé¸æ“‡è³‡æ–™å¤¾
      PENDING_H={ko, en, zh, el:starElement};
      document.getElementById('pickFolderH').style.display='flex'; 
    }
    return;
  }

  // é¸æ“‡æ”¶è—å¤¾
  if(e.target.matches('#pickFolderH [data-folder]')){ 
    const folder=e.target.getAttribute('data-folder'); 
    if(PENDING_H){ 
      const fav=favs(); 
      if(!fav.some(x=>x.ko===PENDING_H.ko&&x.en===PENDING_H.en&&x.zh===PENDING_H.zh&&x.folder===folder)){ 
        fav.unshift({
          ko:PENDING_H.ko,
          en:PENDING_H.en,
          zh:PENDING_H.zh,
          folder,
          ts:Date.now()
        }); 
        localStorage.setItem('favorites', JSON.stringify(fav)); 
      } 
      PENDING_H.el.querySelector('img').src = 'icons/toboki-yellow.svg';
      PENDING_H.el.classList.add('on'); 
      PENDING_H=null; 
      document.getElementById('pickFolderH').style.display='none'; 
    }
    return;
  }
  
  // ç¢ºèªåˆªé™¤
  if(e.target.id==='confirmYes' && PENDING_DELETE){ 
    const fav=favs(); 
    const filtered = fav.filter(f=>!(f.ko===PENDING_DELETE.ko && f.en===PENDING_DELETE.en && f.zh===PENDING_DELETE.zh)); 
    localStorage.setItem('favorites', JSON.stringify(filtered)); 
    PENDING_DELETE.el.querySelector('img').src = 'icons/toboki.svg';
    PENDING_DELETE.el.classList.remove('on'); 
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }
  
  if(e.target.id==='confirmNo' || e.target.id==='confirmClose'){ 
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
    return; 
  }

  if(e.target.closest('#pickFolderH .sheet') && !e.target.matches('[data-folder]') && !e.target.matches('#pickCloseH')) return; 
  
  if(e.target.matches('#pickFolderH')){ 
    PENDING_H = null;
    document.getElementById('pickFolderH').style.display='none'; 
  }
  
  if(e.target.matches('#pickCloseH')){ 
    PENDING_H = null;
    document.getElementById('pickFolderH').style.display='none'; 
  }
  
  if(e.target.matches('#confirmDelete')){ 
    PENDING_DELETE=null;
    document.getElementById('confirmDelete').style.display='none'; 
  }
});

window.speechSynthesis.onvoiceschanged = ()=>{ ensureVoice(); };
ensureVoice(); 
updateSpeedUI();
loadMickeyState();
render();
</script></body></html>
